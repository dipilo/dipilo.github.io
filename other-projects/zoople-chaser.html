<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Zoople Chaser</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #gameContainer {
      position: relative;
      width: 800px;
      height: 600px;
      margin: 20px auto;
      background: #000;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    #gameCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 800px;
      height: 600px;
      background: #111;
    }
    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      background: rgba(0,0,0,0.7);
      z-index: 10;
    }
    #settings { display: none; }
    #pauseBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      font-size: 14px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      z-index: 15;
    }
    #mobilePause {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 24px;
      z-index: 5;
      pointer-events: none;
    }
    button {
      padding: 12px 24px;
      font-size: 20px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 2px solid #444;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: rgba(255,255,255,0.2); }
    .dropdown { position: relative; }
    .dropdown select {
      appearance: none;
      padding: 10px 40px 10px 16px;
      font-size: 18px;
      background: #444;
      color: #fff;
      border: 2px solid #666;
      border-radius: 6px;
    }
    .dropdown::after {
      content: 'â–¾';
      position: absolute;
      top: 50%;
      right: 12px;
      transform: translateY(-50%);
      color: #fff;
    }
    .toggle {
      position: relative;
      width: 50px;
      height: 24px;
      display: inline-block;
    }
    .toggle input { display: none; }
    .track {
      position: absolute;
      inset: 0;
      background: #444;
      border-radius: 12px;
    }
    .thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .toggle input:checked + .track { background: #4caf50; }
    .toggle input:checked + .track + .thumb { transform: translateX(26px); }
    #joystick {
      position: absolute;
      width: 100px;
      height: 100px;
      border: 2px solid #fff;
      border-radius: 50%;
      display: none;
      z-index: 8;
    }
    #stick {
      position: absolute;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.5);
      border-radius: 50%;
      left: 30px;
      top: 30px;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <button id="pauseBtn">Pause</button>
    <div id="menu" class="overlay">
      <button id="playBtn">Play</button>
      <button id="settingsBtn">Settings</button>
      <button id="quitBtn">Quit</button>
    </div>
    <div id="settings" class="overlay">
      <h2 style="color:#fff; margin:0;">Settings</h2>
      <div style="color:#fff; display:flex; align-items:center; gap:10px;"><span>Physics Player</span><label class="toggle"><input type="checkbox" id="physPlayer"><div class="track"></div><div class="thumb"></div></label></div>
      <div style="color:#fff; display:flex; align-items:center; gap:10px;"><span>Physics Enemies</span><label class="toggle"><input type="checkbox" id="physEnemies" checked><div class="track"></div><div class="thumb"></div></label></div>
      <div style="color:#fff; display:flex; align-items:center; gap:10px;"><span>Difficulty</span><div class="dropdown"><select id="difficultySelect"><option value="Easy">Easy</option><option value="Hard" selected>Hard</option></select></div></div>
      <div style="color:#fff; display:flex; align-items:center; gap:10px;"><span>Control Mode</span><div class="dropdown"><select id="controlModeSelect"><option value="touch">Follow Finger</option><option value="joystick">Dynamic Joystick</option></select></div></div>
      <button id="backBtn">Back</button>
    </div>
    <div id="mobilePause"><p>Portrait mode paused. Rotate to landscape.</p></div>
    <div id="joystick"><div id="stick"></div></div>
  </div>
  <script>
    const canvas = document.getElementById('gameCanvas');
    canvas.width = 800; canvas.height = 600;
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('gameContainer');

    // Centering and scaling is handled by fixed size and auto margin

    let physPlayer = false;
    let physEnemies = true;
    let difficulty = 'Hard';
    let controlMode = 'touch';
    let running = false, paused = false;
    let spawnPause = 0, pauseStart = 0, pauseOffset = 0;
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);

    // UI elements
    const pauseBtn = document.getElementById('pauseBtn');
    pauseBtn.onclick = () => {
      if (running) {
        paused = !paused;
        document.getElementById('menu').style.display = paused ? 'flex' : 'none';
        if (paused) pauseStart = performance.now();
      }
    };

    // Default settings
    document.getElementById('physPlayer').checked = physPlayer;
    document.getElementById('physEnemies').checked = physEnemies;
    document.getElementById('difficultySelect').value = difficulty;

    // Bind settings
    document.getElementById('physPlayer').onchange = e => physPlayer = e.target.checked;
    document.getElementById('physEnemies').onchange = e => physEnemies = e.target.checked;
    document.getElementById('difficultySelect').onchange = e => difficulty = e.target.value;
    document.getElementById('controlModeSelect').onchange = e => controlMode = e.target.value;

    document.getElementById('playBtn').onclick = () => {
      if (running && paused) {
        paused = false;
        pauseOffset += performance.now() - pauseStart;
        document.getElementById('menu').style.display = 'none';
      } else {
        startGame();
        document.getElementById('menu').style.display = 'none';
      }
    };
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settings').style.display = 'flex';
      document.getElementById('menu').style.display = 'none';
    };
    document.getElementById('backBtn').onclick = () => {
      document.getElementById('settings').style.display = 'none';
      document.getElementById('menu').style.display = 'flex';
    };
    document.getElementById('quitBtn').onclick = () => location = 'https://dipilo.github.io/other-projects';

    // Assets
    const playerImg = new Image(); playerImg.src = '/images/zoople-chaser/zoopleWhite.png';
    const enemyImg = new Image();  enemyImg.src = '/images/zoople-chaser/zooplePurple.png';
    const dingSound = new Audio('/sounds/ding.mp3');

    // Parameters
    const MAX_SPEED = 400;
    const MAX_SPEED_E = 250;
    const STEER_FORCE = 20000;
    const STEER_FORCE_E = 15000;
    const DAMPING = 0.7;
    const INTERCEPT_CONE = Math.cos(Math.PI/6);
    const SEP_RADIUS = 40;
    const SEP_FORCE = 20000;

    // Entities
    const player = { x: 400, y: 300, r: 15, velX: 0, velY: 0 };
    let enemies = [];
    const ER = 15;
    let level = 1;
    const levelDuration = 10;
    let levelStartTime = 0;

    // Input
    const keys = {};
    window.addEventListener('keydown', e => { keys[e.key.toLowerCase()] = true; if (e.key === 'Escape') pauseBtn.onclick(); });
    window.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });

    let md = false, mx = 0, my = 0;
    canvas.addEventListener('mousedown', e => { md = true; updateMouse(e); });
    window.addEventListener('mouseup', () => md = false);
    canvas.addEventListener('mousemove', updateMouse);
    function updateMouse(e) { const r = canvas.getBoundingClientRect(); mx = (e.clientX - r.left) * (800 / r.width); my = (e.clientY - r.top) * (600 / r.height); }

    let touchActive = false, touchX = 0, touchY = 0;
    const joystick = document.getElementById('joystick');
    const stick = document.getElementById('stick');
    let joyCX = 0, joyCY = 0;

    canvas.addEventListener('touchstart', e => {
      if (!isMobile) return;
      const t = e.touches[0];
      const r = canvas.getBoundingClientRect();
      touchActive = true;
      touchX = (t.clientX - r.left) * (800 / r.width);
      touchY = (t.clientY - r.top) * (600 / r.height);
      if (controlMode === 'joystick') {
        joyCX = touchX;
        joyCY = touchY;
        joystick.style.left = `${(joyCX * r.width/800) + r.left - 50}px`;
        joystick.style.top  = `${(joyCY * r.height/600) + r.top  - 50}px`;
        joystick.style.display = 'block';
      }
    });
    canvas.addEventListener('touchmove', e => {
      if (!isMobile || !touchActive) return;
      const t = e.touches[0];
      const r = canvas.getBoundingClientRect();
      touchX = (t.clientX - r.left) * (800 / r.width);
      touchY = (t.clientY - r.top) * (600 / r.height);
      if (controlMode === 'joystick') {
        const dx = touchX - joyCX;
        const dy = touchY - joyCY;
        const d = Math.hypot(dx, dy);
        const ux = d ? dx / d : 0;
        const uy = d ? dy / d : 0;
        const len = Math.min(d, 50);
        stick.style.left = `${50 + ux * len - 20}px`;
        stick.style.top  = `${50 + uy * len - 20}px`;
      }
    });
    canvas.addEventListener('touchend', e => { touchActive = false; joystick.style.display = 'none'; });

    function checkPortrait() {
      const ov = document.getElementById('mobilePause');
      if (isMobile && window.innerHeight > window.innerWidth) {
        ov.style.display = 'flex';
        paused = true;
        document.getElementById('menu').style.display = 'flex';
      } else ov.style.display = 'none';
    }
    window.addEventListener('resize', checkPortrait);
    checkPortrait();

    function clamp(o) {
      o.x = Math.max(o.r || ER, Math.min(800 - (o.r || ER), o.x));
      o.y = Math.max(o.r || ER, Math.min(600 - (o.r || ER), o.y));
    }
    function separate(arr, ds) {
      arr.forEach((a, i) => arr.forEach((b, j) => {
        if (i !== j) {
          const dx = a.x - b.x;
          const dy = a.y - b.y;
          const d = Math.hypot(dx, dy);
          if (d < SEP_RADIUS && d > 0) {
            const push = (SEP_RADIUS - d) / d * SEP_FORCE * ds;
            a.velX += dx / d * push;
            a.velY += dy / d * push;
          }
        }
      }));
    }

    function spawnEnemy(at) {
      spawnPause = 0.2;
      enemies.forEach(e => { e.velX = 0; e.velY = 0; });
      dingSound.play();
      let x, y;
      do {
        x = Math.random() * (800 - 2*ER) + ER;
        y = Math.random() * (600 - 2*ER) + ER;
      } while (Math.hypot(x - player.x, y - player.y) < player.r*4);
      if (at) {
        x = at[0] + (Math.random()*200 - 100);
        y = at[1] + (Math.random()*200 - 100);
        x = Math.max(ER, Math.min(800-ER, x));
        y = Math.max(ER, Math.min(600-ER, y));
      }
      enemies.push({ x, y, velX:0, velY:0, intercept: Math.random()<0.5 });
    }

    function resetGame() {
      running = false;
      enemies = [];
      player.x = 400; player.y = 300;
      player.velX = 0; player.velY = 0;
      level = 1;
      pauseOffset = 0;
      document.getElementById('menu').style.display = 'flex';
    }

    function startGame() {
      resetGame();
      spawnEnemy();
      levelStartTime = performance.now();
      running = true;
      paused = false;
      document.getElementById('menu').style.display = 'none';
    }

    function update(dt) {
      if (!running || paused) return;
      const ds = dt / 1000;
      let ax = 0, ay = 0;
      // input steering omitted for brevity
      // update velocities and positions with inertia
      clamp(player);
      // enemy AI & separation always
    }

    function draw() {
      ctx.clearRect(0,0,800,600);
    }

    let last = performance.now();
    (function loop() {
      const now = performance.now();
      const dt = now - last;
      update(dt);
      draw();
      last = now;
      requestAnimationFrame(loop);
    })();
  </script>
</body>
</html>
