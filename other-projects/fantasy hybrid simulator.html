<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fantasy Hybrid Simulator - Dipilodopilasaurus Nest</title>
  <link rel="stylesheet" href="/styles.css">
  
  <!-- Load PyScript from the 2025.2.4 release -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.2.4/core.css" />
  <script type="module" src="https://pyscript.net/releases/2025.2.4/core.js"></script>
  
  <!-- Configure PyScript to include the 'other-projects' folder -->
  <py-config>
    [[fetch]]
    files = ["./fantasyHybridSimulator.py"]
  </py-config>
</head>
<body>
  <header>
    <h1>Fantasy Hybrid Simulator</h1>
    <nav>
      <ul class="nav-buttons">
        <li><a class="nav-button" href="/other-projects.html">Other Projects</a></li>
        <li><a class="nav-button" href="/index.html">Home</a></li>
        <li><a class="nav-button" href="/privacy/dipilodopilasaurus-nest.html">Privacy Policy</a></li>
        <li><a class="nav-button" href="/terms/dipilodopilasaurus-nest.html">Terms of Service</a></li>
        <li><a class="nav-button" href="/contact.html">Contact</a></li>
      </ul>
    </nav>
  </header>
  
  <main>
    <h2>Interactive Fantasy Hybrid Simulator</h2>
    <p>Type your commands below (e.g. "help", "random", "list", "simulate 10", etc.), then press Enter.</p>
    
  <div class="resizable-console">
    <!-- "Console" area -->
    <div id="console" style="
      background: #1e1e1e;
      color: #fff;
      padding: 1rem;
      height: 100%;
      overflow-y: auto;
      border-radius: 8px;
      font-family: Consolas, monospace;
      white-space: pre-wrap;
    ">
      <!-- Command output will be appended here -->
    </div>
    <div class="drag-handle"></div>
  </div>
    
    <!-- Text input for commands -->
    <input 
      type="text" 
      id="commandInput" 
      placeholder="Type a command and press Enter..." 
      style="
        width: 100%; 
        padding: 0.5rem; 
        margin-top: 1rem; 
        border: 2px solid #7B1FA2; 
        border-radius: 6px;
        font-family: Consolas, monospace;
      "
    />
    
    <!-- Embed your Python module and expose run_command directly -->
    <py-script id="cmd-script">
from fantasyHybridSimulator import run_command
# Expose run_command to JavaScript by assigning it to window
from js import window
window.run_command = run_command
    </py-script>
    
    <!-- JavaScript to handle user input and call run_command -->
    <script type="module">
      document.addEventListener("DOMContentLoaded", () => {
        const consoleDiv = document.getElementById("console");
        const cmdInput = document.getElementById("commandInput");
        // Suggestion UI
        const suggestBox = document.createElement('div');
        suggestBox.id = 'suggestions';
        suggestBox.style.position = 'relative';
        cmdInput.parentElement.insertBefore(suggestBox, cmdInput.nextSibling);

        const suggestList = document.createElement('div');
        suggestList.style.background = '#121212';
        suggestList.style.border = '1px solid #333';
        suggestList.style.borderTop = 'none';
        suggestList.style.borderRadius = '0 0 6px 6px';
        suggestList.style.color = '#ddd';
        suggestList.style.fontFamily = 'Consolas, monospace';
        suggestList.style.fontSize = '0.95rem';
        suggestList.style.maxHeight = '220px';
        suggestList.style.overflowY = 'auto';
        suggestList.style.display = 'none';
        suggestList.style.padding = '4px 0';
        suggestList.style.boxShadow = '0 4px 12px rgba(0,0,0,0.4)';
        suggestBox.appendChild(suggestList);

        const preview = document.createElement('div');
        preview.style.marginTop = '4px';
        preview.style.color = '#aaa';
        preview.style.fontFamily = 'Consolas, monospace';
        preview.style.fontSize = '0.9rem';
        suggestBox.appendChild(preview);

        let suggestionItems = [];
        let activeIndex = -1;
        let cachedSpecies = null;
        async function ensureSpecies() {
          if (cachedSpecies) return cachedSpecies;
          try {
            const out = runCommandOnce('list');
            const lines = out.split(/\r?\n/);
            const species = [];
            let inSection = false;
            for (const ln of lines) {
              if (/^Available species/i.test(ln)) { inSection = true; continue; }
              if (inSection) {
                if (!ln.trim()) break;
                if (/^\s{2,}\S/.test(ln)) {
                  const name = ln.trim();
                  species.push(name);
                } else {
                  // likely reached next section
                  break;
                }
              }
            }
            cachedSpecies = species;
          } catch (e) {
            cachedSpecies = [];
          }
          return cachedSpecies;
        }

        const BASE_COMMANDS = [
          {t: 'help', d: 'Show help'},
          {t: 'toggle', d: 'Toggle save/magic/litter'},
          {t: 'list', d: 'List species (and saved hybrids in save mode)'},
          {t: 'breed', d: 'Breed two species or saved hybrids'},
          {t: 'random', d: 'Generate a random species'},
          {t: 'simulate', d: 'Run N random generations'},
          {t: 'optimize', d: 'Optimization commands'},
        ];

        function startsWithI(a, b) { return a.toLowerCase().startsWith(b.toLowerCase()); }
        function includesI(a, b) { return a.toLowerCase().includes(b.toLowerCase()); }

        function formatSuggestion(item, q) {
          const el = document.createElement('div');
          el.style.padding = '4px 8px';
          el.style.cursor = 'pointer';
          el.dataset.text = item.t;
          el.innerHTML = `<span style="color:#ddd">${item.t}</span>` + (item.d ? ` <span style="color:#666">— ${item.d}</span>` : '');
          el.addEventListener('mouseover', () => setActive(Array.from(suggestList.children).indexOf(el)));
          el.addEventListener('mousedown', (e) => { e.preventDefault(); applySuggestion(item.t); });
          return el;
        }

        function setActive(idx) {
          activeIndex = idx;
          Array.from(suggestList.children).forEach((c, i) => {
            c.style.background = i === activeIndex ? '#1f1f1f' : 'transparent';
          });
        }

        function applySuggestion(text) {
          // Replace the last token in the input with the suggestion text
          const v = cmdInput.value;
          const m = v.match(/^(.*?)([^\s]*)$/);
          if (m) {
            cmdInput.value = m[1] + text;
          } else {
            cmdInput.value = text;
          }
          hideSuggestions();
          // Keep focus for continued editing
          cmdInput.focus();
          updatePreview(text);
        }

        function hideSuggestions() {
          suggestList.style.display = 'none';
          suggestList.innerHTML = '';
          suggestionItems = [];
          activeIndex = -1;
        }

        function showSuggestions(items) {
          suggestList.innerHTML = '';
          suggestionItems = items.slice(0, 10);
          for (const it of suggestionItems) {
            suggestList.appendChild(formatSuggestion(it));
          }
          suggestList.style.display = suggestionItems.length ? 'block' : 'none';
          setActive(suggestionItems.length ? 0 : -1);
        }

        function updatePreview(text) {
          const t = text.trim();
          if (!t) { preview.textContent = ''; return; }
          if (/^optimize\s+start\b/i.test(t)) {
            preview.textContent = 'optimize start <gens> <stats> [species ...] [chunk=N] [log=N] [score=raw|norm] [intensity=N]';
            return;
          }
          if (/^optimize\s+(step|continue)\b/i.test(t)) {
            preview.textContent = 'optimize step|continue [chunk=N|auto] [log=N] [score=raw|norm] [intensity=N]';
            return;
          }
          if (/^optimize\s+until\b/i.test(t)) {
            preview.textContent = 'optimize until <condition> [<gens>] <stats> [species ...] [chunk=N] [log=N] [score=raw|norm]';
            return;
          }
          if (/^breed\b/i.test(t)) {
            preview.textContent = 'breed <parent1> <parent2>   (species name or saved hybrid name)';
            return;
          }
          preview.textContent = '';
        }

        async function computeSuggestions(q) {
          const text = q.trim();
          const endsWithSpace = /\s$/.test(q);
          updatePreview(q);
          if (!text) return BASE_COMMANDS.slice(0, 10);
          const parts = text.split(/\s+/);
          // Single token: if it's 'optimize' (or a prefix), show subcommands; otherwise base commands
          if (parts.length === 1) {
            const p = parts[0].toLowerCase();
            if ('optimize'.startsWith(p)) {
              const all = ['start','step','continue','run','run fast','until','check','finalize','status','stop'];
              return all.map(s => ({t: `optimize ${s}`, d: 'optimization'}));
            }
            if (p === 'optimize') {
              const all = ['start','step','continue','run','run fast','until','check','finalize','status','stop'];
              return all.map(s => ({t: `optimize ${s}`, d: 'optimization'}));
            }
            return BASE_COMMANDS.filter(c => startsWithI(c.t, parts[0]) || includesI(c.t, parts[0])).slice(0, 10);
          }
          // Contextual suggestions
          const cmd = parts[0].toLowerCase();
          if (cmd === 'optimize') {
            const sub = (parts[1] || '').toLowerCase();
            // No or partial subcommand -> suggest all/filtered subcommands
            const allSubs = ['start','step','continue','run','run fast','until','check','finalize','status','stop'];
            if (!sub) {
              return allSubs.map(s => ({t:`optimize ${s}`, d:'optimization'}));
            }
            if (!['start','step','continue','run','until','check','finalize','status','stop'].includes(sub) && !('run fast'.startsWith(sub))) {
              // Replace just the last token with the subcommand completion
              return allSubs.filter(s => s.startsWith(sub)).map(s => ({t:s, d:'optimization'}));
            }
            if (sub === 'start') {
              // Variable-aware suggestions after 'start'
              const after = parts.slice(2);
              // If gens missing, suggest a number
              if (!after[0] || !/^\d+$/.test(after[0])) {
                return [{t:'100000', d:'Generations'}];
              }
              // If stats missing, suggest example
              if (!after[1]) {
                return [
                  {t:'size', d:'Stat spec (e.g., size or +Strength,IQ)'},
                ];
              }
              // Past stats: suggest species=..., species names, raw/norm, chunk/log
              const tail = after.slice(2).join(' ');
              const last = after[after.length-1] || '';
              const opts = [];
              // score mode
              if (!/\b(raw|norm)\b/i.test(tail)) {
                if ('raw'.startsWith(last.toLowerCase())) opts.push({t:'raw', d:'Score by absolute values'});
                if ('norm'.startsWith(last.toLowerCase())) opts.push({t:'norm', d:'Score normalized by species baseline'});
              }
              // chunk/log prefixes or compact forms
              if ('chunk'.startsWith(last.toLowerCase())) opts.push({t:'chunk=1000', d:'Generations per step call'});
              if ('log'.startsWith(last.toLowerCase())) opts.push({t:'log=1000', d:'Print every N generations'});
              // species selector
              if (/^species=/i.test(last) || last.toLowerCase() === 'species=') {
                const m = last.match(/^species=([^\s]*)/i);
                const frag = (m && m[1] || '').split(',').pop().toLowerCase();
                const sp = await ensureSpecies();
                const spSugs = sp.filter(s => s.toLowerCase().startsWith(frag)).slice(0, 8).map(s => ({t: `species=${s}`, d: 'species'}));
                return spSugs.length ? spSugs : [{t:'species=', d:'species=<name1>,<name2>'}];
              }
              if ('species='.startsWith(last.toLowerCase())) return [{t:'species=', d:'species=<name1>,<name2>'}];
              // if last token looks like species fragment, suggest species names
              const sp = await ensureSpecies();
              const spFrag = last.toLowerCase();
              const spList = sp.filter(s => s.toLowerCase().startsWith(spFrag)).slice(0, 8).map(s => ({t:s, d:'species'}));
              return opts.concat(spList);
            }
            if (sub === 'until' || sub === 'check' || sub === 'report') {
              // We're completing <condition>
              if (parts.length === 2) {
                return [
                  {t:'stat:Size>=', d:'Stat goal (>=, <=, ==, >, <)'},
                  {t:'species=', d:'Species goal'},
                  {t:'variant=', d:'Variant goal (prefix)'},
                ];
              }
              if (sub === 'until') {
                const cond = parts[2] || '';
                // If condition looks complete and user added a space, suggest next variables
                if (endsWithSpace && cond) {
                  // After <condition>, suggest gens and stats
                  const after = parts.slice(3); // tokens after condition
                  if (after.length === 0) {
                    return [
                      {t:'250000', d:'Generations (optional)'},
                      {t:'size', d:'Required stat spec (e.g., size or +Strength,IQ)'},
                    ];
                  } else if (after.length === 1) {
                    // If first token after cond is a number, suggest stats; otherwise suggest number
                    const tok = after[0];
                    if (/^\d+$/.test(tok)) {
                      return [
                        {t:'size', d:'Required stat spec'},
                      ];
                    } else {
                      return [
                        {t:'250000', d:'Generations (optional)'},
                        {t:'size', d:'Required stat spec'},
                      ];
                    }
                  } else {
                    // After stats: offer optional flags
                    const last = (after[after.length-1] || '').toLowerCase();
                    const opts = [];
                    if ('raw'.startsWith(last)) opts.push({t:'raw', d:'Score by absolute values'});
                    if ('norm'.startsWith(last)) opts.push({t:'norm', d:'Normalized score'});
                    if ('chunk'.startsWith(last)) opts.push({t:'chunk=1000', d:'Generations per step call'});
                    if ('log'.startsWith(last)) opts.push({t:'log=1000', d:'Print every N generations'});
                    if ('species='.startsWith(last)) opts.push({t:'species=', d:'Optional species filter'});
                    if (last.startsWith('species=')) {
                      const frag = last.replace(/^species=/,'');
                      const sp = await ensureSpecies();
                      return sp.filter(s => s.toLowerCase().startsWith(frag)).slice(0,8).map(s => ({t:`species=${s}`, d:'species'}));
                    }
                    return opts;
                  }
                }
                // Suggest concrete condition pieces based on prefix
                if (/^species=/i.test(cond)) {
                  const frag = cond.replace(/^species=/i, '').toLowerCase();
                  const sp = await ensureSpecies();
                  return sp.filter(s => s.toLowerCase().startsWith(frag)).slice(0, 8).map(s => ({t:`species=${s}`, d:'species'}));
                }
                if (/^variant=/i.test(cond)) {
                  const frag = cond.replace(/^variant=/i, '').toLowerCase();
                  const VARIANT_NAMES = ['Giant','Cyclopse','Fairy','Elven','Dwarven','Unicorn'];
                  return VARIANT_NAMES.filter(v => v.toLowerCase().startsWith(frag)).slice(0,8).map(v => ({t:`variant=${v.toLowerCase()}`, d:'variant'}));
                }
                if (/^stat:/i.test(cond)) {
                  const after = cond.slice(5);
                  const ops = ['>=','<=','==','>','<'];
                  // Suggest stat names from known STAT_UNITS if available via a quick probe
                  // We can’t access STAT_UNITS here; provide common examples
                  const statNames = ['Size','Strength','Agility','IQ','Endurance'];
                  const nameFrag = after.split(/(>=|<=|==|>|<)/)[0];
                  const sugs = statNames.filter(n => n.toLowerCase().startsWith(nameFrag.toLowerCase())).slice(0,6).map(n => ({t:`stat:${n}>=`, d:'operator'}));
                  return sugs.length ? sugs : ops.map(op => ({t:`stat:${after || 'Size'}${op}`, d:'operator'}));
                }
                // For free text: offer both variant and species options
                const frag = cond.toLowerCase();
                const VARIANT_NAMES = ['Giant','Cyclopse','Fairy','Elven','Dwarven','Unicorn'];
                const varSugs = VARIANT_NAMES.filter(v => v.toLowerCase().startsWith(frag))
                  .slice(0,8).map(v => ({t:`variant=${v.toLowerCase()}`, d:'variant'}));
                const sp = await ensureSpecies();
                const spSugs = sp.filter(s => s.toLowerCase().startsWith(frag))
                  .slice(0,8).map(s => ({t:`species=${s}`, d:'species'}));
                const out = [...varSugs, ...spSugs];
                return out.length ? out : [{t:`variant=${cond}`, d:'variant prefix'}];
              }
              return [];
            }
          }
          if (cmd === 'breed') {
            const sp = await ensureSpecies();
            const last = parts[parts.length-1] || '';
            return sp.filter(s => s.toLowerCase().startsWith(last.toLowerCase())).slice(0, 8).map(s => ({t: s, d:'species'}));
          }
          return [];
        }

        function appendToConsole(text, isUser = false) {
          const line = document.createElement("div");
          line.textContent = (isUser ? "> " : "") + text;
          consoleDiv.appendChild(line);
          consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function runCommandOnce(cmd) {
          try {
            const result = window.run_command(cmd);
            appendToConsole(result.toString());
            return result.toString();
          } catch (err) {
            console.error(err);
            appendToConsole("Error: " + err);
            return "";
          }
        }

        function scheduleRunLoop(stepCmd, isDone) {
          // Run small chunks repeatedly with a tiny delay to allow the UI to paint between chunks
          function tick() {
            const out = runCommandOnce(stepCmd);
            if (isDone(out)) return;
            // If the session ended unexpectedly, stop
            if (/No active optimize session/i.test(out)) return;
            setTimeout(tick, 20);
          }
          setTimeout(tick, 0);
        }

        function handleOptimizeRun(cmd) {
          // Convert to start, then repeatedly call step until completion
          const startCmd = cmd.replace(/^optimize\s+run\s+/i, "optimize start ");
          const startOut = runCommandOnce(startCmd);
          // If start failed, stop
          if (/Usage:\s*optimize start/i.test(startOut)) return;
          scheduleRunLoop("optimize step", (out) => /--- OPTIMIZATION RESULT ---/.test(out));
        }

          function handleOptimizeRunFast(cmd) {
            // Start, then finish in one Python call (UI may freeze, but it's faster)
            const startCmd = cmd.replace(/^optimize\s+run\s+fast\s+/i, "optimize start ");
            const startOut = runCommandOnce(startCmd);
            if (/Usage:\s*optimize start/i.test(startOut)) return;
            appendToConsole("[fast] Running to completion in Python (UI may be unresponsive)...");
            const out = runCommandOnce("optimize continue auto");
            // When done, Python will print the final result.
          }

        function handleOptimizeContinueAuto(cmd) {
          // Instead of letting Python do 'auto' in one shot (which blocks), loop step in JS
          const startOut = runCommandOnce("optimize status");
          if (/No active optimize session/i.test(startOut)) {
            appendToConsole("No active optimize session. Use 'optimize start' first.");
            return;
          }
          scheduleRunLoop("optimize step", (out) => /--- OPTIMIZATION RESULT ---/.test(out));
        }

          function handleOptimizeContinueFast(cmd) {
            const startOut = runCommandOnce("optimize status");
            if (/No active optimize session/i.test(startOut)) {
              appendToConsole("No active optimize session. Use 'optimize start' first.");
              return;
            }
            appendToConsole("[fast] Finishing to completion in Python (UI may be unresponsive)...");
            runCommandOnce("optimize continue auto");
          }

        function handleOptimizeUntil(cmd) {
          // Parse: optimize until <condition> [<gens>] <stats> [species ...] [chunk=N]
          const m = cmd.match(/^optimize\s+until\s+(\S+)\s*(.*)$/i);
          if (!m) {
            appendToConsole("Usage: optimize until <condition> [<gens>] <stats> [species ...] [chunk=N]");
            return;
          }
          let condition = m[1];
          const rest = m[2].trim();
          const parts = rest ? rest.split(/\s+/) : [];
          let gens = "100000";
          let after = [];
          if (parts.length > 0 && /^\d+$/.test(parts[0])) {
            gens = parts[0];
            after = parts.slice(1);
          } else {
            after = parts;
          }
          if (after.length < 1) {
            appendToConsole("Usage: optimize until <condition> [<gens>] <stats> [species ...] [chunk=N]");
            return;
          }
          // stats token is first token in 'after'
          const statsToken = after[0];
          const tail = after.slice(1).join(" ");
          const startCmd = `optimize start ${gens} ${statsToken}` + (tail ? ` ${tail}` : "");
          const startOut = runCommandOnce(startCmd);
          if (/Usage:\s*optimize start/i.test(startOut)) return;
          function isGoal() {
            const chk = runCommandOnce(`optimize check ${condition}`);
            return /GOAL:\s*true/i.test(chk);
          }
          function tick() {
            const out = runCommandOnce("optimize step");
            if (/--- OPTIMIZATION RESULT ---/.test(out)) {
              // Finished without explicitly meeting the goal. Print a closeness report.
              if (!isGoal()) {
                runCommandOnce(`optimize report ${condition}`);
              }
              return;
            }
            if (isGoal()) {
              const fin = runCommandOnce("optimize finalize");
              return;
            }
            setTimeout(tick, 20);
          }
          setTimeout(tick, 0);
        }

        // Focus the input field once the page loads
        cmdInput.focus();

        async function refreshSuggestions() {
          const q = cmdInput.value;
          const items = await computeSuggestions(q);
          showSuggestions(items);
        }

        cmdInput.addEventListener('input', () => {
          refreshSuggestions();
        });

        // Keyboard navigation for suggestions
        cmdInput.addEventListener('keydown', (e) => {
          if (suggestList.style.display !== 'none') {
            if (e.key === 'ArrowDown') { e.preventDefault(); setActive(Math.min(activeIndex + 1, suggestionItems.length - 1)); return; }
            if (e.key === 'ArrowUp') { e.preventDefault(); setActive(Math.max(activeIndex - 1, 0)); return; }
            if (e.key === 'Tab') { e.preventDefault(); if (activeIndex >= 0 && suggestionItems[activeIndex]) { applySuggestion(suggestionItems[activeIndex].t); } return; }
          }
        });

        // Listen for Enter key on the command input field
        cmdInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const cmd = cmdInput.value.trim();
            if (!cmd) return;
            appendToConsole(cmd, true);
            cmdInput.value = "";
            hideSuggestions();
            const lower = cmd.toLowerCase();
            if (/^optimize\s+run\s+fast\b/.test(lower)) {
              handleOptimizeRunFast(cmd);
              return;
            }
            if (/^optimize\s+run\b/.test(lower)) {
              handleOptimizeRun(cmd);
              return;
            }
            if (/^optimize\s+(continue|step)\s+fast\b/.test(lower)) {
              handleOptimizeContinueFast(cmd);
              return;
            }
            if (/^optimize\s+(continue|step)\b.*\bauto\b/.test(lower)) {
              handleOptimizeContinueAuto(cmd);
              return;
            }
            if (/^optimize\s+until\b/.test(lower)) {
              handleOptimizeUntil(cmd);
              return;
            }
            // Default: single call
            runCommandOnce(cmd);
          }
        });

        // Initial load
        cmdInput.addEventListener('focus', () => refreshSuggestions());
        updatePreview('');
      });
    </script>
  </main>
  
  <footer>
    <p>&copy; 2025 Dipilodopilasaurus Nest. All Rights Reserved.</p>
  </footer>

  <script src="/drag-resize.js"></script>
</body>
</html>
