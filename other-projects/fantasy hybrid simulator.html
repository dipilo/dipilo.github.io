<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fantasy Hybrid Simulator - Dipilodopilasaurus Nest</title>
  <link rel="stylesheet" href="/styles.css">
  
  <!-- Load PyScript from the 2025.2.4 release -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.2.4/core.css" />
  <script type="module" src="https://pyscript.net/releases/2025.2.4/core.js"></script>
  
  <!-- Configure PyScript to include the 'other-projects' folder -->
  <py-config>
    [[fetch]]
    files = ["./fantasyHybridSimulator.py"]
  </py-config>
</head>
<body>
  <header>
    <h1>Fantasy Hybrid Simulator</h1>
    <nav>
      <ul class="nav-buttons">
        <li><a class="nav-button" href="/other-projects.html">Other Projects</a></li>
        <li><a class="nav-button" href="/index.html">Home</a></li>
        <li><a class="nav-button" href="/privacy/dipilodopilasaurus-nest.html">Privacy Policy</a></li>
        <li><a class="nav-button" href="/terms/dipilodopilasaurus-nest.html">Terms of Service</a></li>
        <li><a class="nav-button" href="/contact.html">Contact</a></li>
      </ul>
    </nav>
  </header>
  
  <main>
    <h2>Interactive Fantasy Hybrid Simulator</h2>
    <p>Type your commands below (e.g. "help", "random", "list", "simulate 10", etc.), then press Enter.</p>
    
  <div class="resizable-console">
    <!-- "Console" area -->
    <div id="console" style="
      background: #1e1e1e;
      color: #fff;
      padding: 1rem;
      height: 100%;
      overflow-y: auto;
      border-radius: 8px;
      font-family: Consolas, monospace;
      white-space: pre-wrap;
    ">
      <!-- Command output will be appended here -->
    </div>
    <div class="drag-handle"></div>
  </div>
    
    <!-- Text input for commands -->
    <input 
      type="text" 
      id="commandInput" 
      placeholder="Type a command and press Enter..." 
      style="
        width: 100%; 
        padding: 0.5rem; 
        margin-top: 1rem; 
        border: 2px solid #7B1FA2; 
        border-radius: 6px;
        font-family: Consolas, monospace;
      "
    />
    
    <!-- Embed your Python module and expose run_command directly -->
    <py-script id="cmd-script">
from fantasyHybridSimulator import run_command
# Expose run_command to JavaScript by assigning it to window
from js import window
window.run_command = run_command
    </py-script>
    
    <!-- JavaScript to handle user input and call run_command -->
    <script type="module">
      document.addEventListener("DOMContentLoaded", () => {
        const consoleDiv = document.getElementById("console");
        const cmdInput = document.getElementById("commandInput");

        function appendToConsole(text, isUser = false) {
          const line = document.createElement("div");
          line.textContent = (isUser ? "> " : "") + text;
          consoleDiv.appendChild(line);
          consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function runCommandOnce(cmd) {
          try {
            const result = window.run_command(cmd);
            appendToConsole(result.toString());
            return result.toString();
          } catch (err) {
            console.error(err);
            appendToConsole("Error: " + err);
            return "";
          }
        }

        function scheduleRunLoop(stepCmd, isDone) {
          // Run small chunks repeatedly with a tiny delay to allow the UI to paint between chunks
          function tick() {
            const out = runCommandOnce(stepCmd);
            if (isDone(out)) return;
            // If the session ended unexpectedly, stop
            if (/No active optimize session/i.test(out)) return;
            setTimeout(tick, 20);
          }
          setTimeout(tick, 0);
        }

        function handleOptimizeRun(cmd) {
          // Convert to start, then repeatedly call step until completion
          const startCmd = cmd.replace(/^optimize\s+run\s+/i, "optimize start ");
          const startOut = runCommandOnce(startCmd);
          // If start failed, stop
          if (/Usage:\s*optimize start/i.test(startOut)) return;
          scheduleRunLoop("optimize step", (out) => /--- OPTIMIZATION RESULT ---/.test(out));
        }

          function handleOptimizeRunFast(cmd) {
            // Start, then finish in one Python call (UI may freeze, but it's faster)
            const startCmd = cmd.replace(/^optimize\s+run\s+fast\s+/i, "optimize start ");
            const startOut = runCommandOnce(startCmd);
            if (/Usage:\s*optimize start/i.test(startOut)) return;
            appendToConsole("[fast] Running to completion in Python (UI may be unresponsive)...");
            const out = runCommandOnce("optimize continue auto");
            // When done, Python will print the final result.
          }

        function handleOptimizeContinueAuto(cmd) {
          // Instead of letting Python do 'auto' in one shot (which blocks), loop step in JS
          const startOut = runCommandOnce("optimize status");
          if (/No active optimize session/i.test(startOut)) {
            appendToConsole("No active optimize session. Use 'optimize start' first.");
            return;
          }
          scheduleRunLoop("optimize step", (out) => /--- OPTIMIZATION RESULT ---/.test(out));
        }

          function handleOptimizeContinueFast(cmd) {
            const startOut = runCommandOnce("optimize status");
            if (/No active optimize session/i.test(startOut)) {
              appendToConsole("No active optimize session. Use 'optimize start' first.");
              return;
            }
            appendToConsole("[fast] Finishing to completion in Python (UI may be unresponsive)...");
            runCommandOnce("optimize continue auto");
          }

        function handleOptimizeUntil(cmd) {
          // Parse: optimize until <condition> [<gens>] <stats> [species ...] [chunk=N]
          const m = cmd.match(/^optimize\s+until\s+(\S+)\s*(.*)$/i);
          if (!m) {
            appendToConsole("Usage: optimize until <condition> [<gens>] <stats> [species ...] [chunk=N]");
            return;
          }
          let condition = m[1];
          const rest = m[2].trim();
          const parts = rest ? rest.split(/\s+/) : [];
          let gens = "100000";
          let after = [];
          if (parts.length > 0 && /^\d+$/.test(parts[0])) {
            gens = parts[0];
            after = parts.slice(1);
          } else {
            after = parts;
          }
          if (after.length < 1) {
            appendToConsole("Usage: optimize until <condition> [<gens>] <stats> [species ...] [chunk=N]");
            return;
          }
          // stats token is first token in 'after'
          const statsToken = after[0];
          const tail = after.slice(1).join(" ");
          const startCmd = `optimize start ${gens} ${statsToken}` + (tail ? ` ${tail}` : "");
          const startOut = runCommandOnce(startCmd);
          if (/Usage:\s*optimize start/i.test(startOut)) return;
          function isGoal() {
            const chk = runCommandOnce(`optimize check ${condition}`);
            return /GOAL:\s*true/i.test(chk);
          }
          function tick() {
            const out = runCommandOnce("optimize step");
            if (/--- OPTIMIZATION RESULT ---/.test(out)) {
              // Finished without explicitly meeting the goal. Print a closeness report.
              if (!isGoal()) {
                runCommandOnce(`optimize report ${condition}`);
              }
              return;
            }
            if (isGoal()) {
              const fin = runCommandOnce("optimize finalize");
              return;
            }
            setTimeout(tick, 20);
          }
          setTimeout(tick, 0);
        }

        // Focus the input field once the page loads
        cmdInput.focus();

        // Listen for Enter key on the command input field
        cmdInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const cmd = cmdInput.value.trim();
            if (!cmd) return;
            appendToConsole(cmd, true);
            cmdInput.value = "";
            const lower = cmd.toLowerCase();
            if (/^optimize\s+run\s+fast\b/.test(lower)) {
              handleOptimizeRunFast(cmd);
              return;
            }
            if (/^optimize\s+run\b/.test(lower)) {
              handleOptimizeRun(cmd);
              return;
            }
            if (/^optimize\s+(continue|step)\s+fast\b/.test(lower)) {
              handleOptimizeContinueFast(cmd);
              return;
            }
            if (/^optimize\s+(continue|step)\b.*\bauto\b/.test(lower)) {
              handleOptimizeContinueAuto(cmd);
              return;
            }
            if (/^optimize\s+until\b/.test(lower)) {
              handleOptimizeUntil(cmd);
              return;
            }
            // Default: single call
            runCommandOnce(cmd);
          }
        });
      });
    </script>
  </main>
  
  <footer>
    <p>&copy; 2025 Dipilodopilasaurus Nest. All Rights Reserved.</p>
  </footer>

  <script src="/drag-resize.js"></script>
</body>
</html>
